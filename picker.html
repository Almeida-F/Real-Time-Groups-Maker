<script>   
  // from the Google Developers Console.
  const DEVELOPER_KEY = "";
  // number obtained from the Google Developers Console.
  const CLOUD_PROJECT_NUMBER = "";

  let pickerApiLoaded = false;
  let oauthToken;
  let spreadsheetId = '';

  /**
   * Loads the Google Picker API.
   */
  function onApiLoad() {
    gapi.load("picker", {
      callback: function () {
        pickerApiLoaded = true;
      },
    });
  }

  /**
   * Gets the user's OAuth 2.0 access token from the server-side script so that
   * it can be passed to Picker. This technique keeps Picker from needing to
   * show its own authorization dialog, but is only possible if the OAuth scope
   * that Picker needs is available in Apps Script. Otherwise, your Picker code
   * will need to declare its own OAuth scopes.
   */
  function getOAuthToken() {
    google.script.run
      .withSuccessHandler((token) => {
        oauthToken = token;
        createPicker(token);
      })
      .withFailureHandler(showError)
      .getOAuthToken();
  }

  /**
   * Creates a Picker that can access the user's spreadsheets. This function
   * uses advanced options to hide the Picker's left navigation panel and
   * default title bar.
   *
   * @param {string} token An OAuth 2.0 access token that lets Picker access the
   *     file type specified in the addView call.
   */
  function createPicker(token) {
    document.getElementById("result").innerHTML = "";

    if (pickerApiLoaded && token) {
      const picker = new google.picker.PickerBuilder()
        // Instruct Picker to display only spreadsheets in Drive. For other
        // views, see https://developers.google.com/picker/reference/picker.viewid
        .addView(
          new google.picker.DocsView(
            google.picker.ViewId.SPREADSHEETS
          ).setOwnedByMe(true)
        )
        // Hide the navigation panel so that Picker fills more of the dialog.
        .enableFeature(google.picker.Feature.NAV_HIDDEN)
        // Hide the title bar since an Apps Script dialog already has a title.
        .hideTitleBar()
        .setOAuthToken(token)
        .setDeveloperKey(DEVELOPER_KEY)
        .setAppId(CLOUD_PROJECT_NUMBER)
        .setCallback(pickerCallback)
        .setOrigin(google.script.host.origin)
        .build();
      picker.setVisible(true);      
    } else {
      showError("Unable to load the file picker.");
    }
  }

  /**
   * A callback function that extracts the chosen document's metadata from the
   * response object. For details on the response object, see
   * https://developers.google.com/picker/reference/picker.responseobject
   *
   * @param {object} data The response object.
   */
  function pickerCallback(data) {
    if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
      var doc = data[google.picker.Response.DOCUMENTS][0];
      spreadsheetId = doc[google.picker.Document.ID];
      
      console.log('Selected file ID: ' + spreadsheetId);
      
      select('#initialPicker').hide();
      select('#loading').show();
      select('#loading').html("loading...");  
      select('#groupmaker').hide();    
      select('#studentList').html('');
      select('#groupsMakerMenu').hide();
      google.script.run.withSuccessHandler(classPicking).getAllClassData(spreadsheetId, true); 
    }
  }

  /**
   * Handles `"PICKED"` responsed from the Google Picker.
   *
   * @param {object} data The response object.
   */
  function handlePicked(data) {
    const doc = data[google.picker.Response.DOCUMENTS][0];
    const id = doc[google.picker.Document.ID];

    google.script.run
      .withSuccessHandler((driveFilesGetResponse) => {
        // Render the response from Picker and the Drive.Files.Get API.
        const resultElement = document.getElementById("result");
        resultElement.innerHTML = "";

        for (const response of [
          {
            title: "Picker response",
            content: JSON.stringify(data, null, 2),
          },
          {
            title: "Drive.Files.Get response",
            content: JSON.stringify(driveFilesGetResponse, null, 2),
          },
        ]) {
          const titleElement = document.createElement("h3");
          titleElement.appendChild(document.createTextNode(response.title));
          resultElement.appendChild(titleElement);

          const contentElement = document.createElement("pre");
          contentElement.appendChild(
            document.createTextNode(response.content)
          );
          resultElement.appendChild(contentElement);
        }
      })
      .withFailureHandler(showError)
      .getFile(data[google.picker.Response.DOCUMENTS][0].id);
  }

  /**
   * Displays an error message within the #result element.
   *
   * @param {string} message The error message to display.
   */
  function showError(message) {
    document.getElementById("result").innerHTML = "Error: " + message;
  }

</script>


